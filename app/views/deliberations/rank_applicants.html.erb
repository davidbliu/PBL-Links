<script type = 'text/javascript'>
function submitRankings(){
	var r = confirm("You are about to update rankings, are you sure?");
	if (r == false){
		return;
	}
	ranking_data = [];
	$('.applicant-row').each(function(){
		row_data = {};
		row_data['applicant_id'] = $(this).attr('id');
		row_data['rank_value'] = $(this).children(".applicant-rank-td").children(".applicant-rank-input").val();
		ranking_data.push(row_data);
	});
	console.log(ranking_data);
	console.log("that was ranking_data");
	$.ajax({
      url:'/deliberations/<%= @deliberation.id %>/update_rankings?committee_id=<%= @committee.id %>',
      type: "POST",
      data: {"ranking_data": ranking_data},
      success:function(data){
        // alert('completed');
        alert(data);
      },
      complete:function(){
      	
      },
      error:function (xhr, textStatus, thrownError){
        alert('failed');
      }
  });
}
function compare(a,b) {
  if (a['rank'] < b['rank'])
     return -1;
  if (a['rank'] > b['rank'])
    return 1;
  return 0;
}

function reorderRankings(){
	rows = [];
	$('.applicant-row').each(function(){
		row = {};
		row['html'] = $(this)
		row['rank'] = parseInt($(this).children(".applicant-rank-td").children(".applicant-rank-input").val());
		rows.push(row);
	});
	rows.sort(compare);
	console.log(rows);
	$('.applicant-row').each(function(){
		$(this).remove();
	});
	for(var i=0;i<rows.length;i++){
		$("#ranking-table-body").append(rows[i]['html']);
	}
	reorderActions();
}
function reorderActions(){
	$('.applicant-rank-input').keyup(function (event) {
        if (event.keyCode == '13') {
        	reorderRankings();  	
        }
    });
    $('.applicant-rank-input').focusout(function() {
        reorderRankings();  	
    });
    boldActions();

}
function boldActions(){
	$('.applicant-row').click(function(){
		$('.selected-row').removeClass('selected-row');
		$(this).addClass("selected-row");

		selected_canvas = $(".selected-row").children('.applicant-canvas-td').children('.applicant-canvas')[0];
		// canvas = document.getElementById("tiny-image-canvas"),
		canvas = document.getElementById('preview-canvas');
		context = canvas.getContext("2d"),
		pic = selected_canvas;
		context.drawImage(pic, 0, 0, 320, 240);
		
	});
}

// Converts canvas to an image
function convertCanvasToImage(canvas) {
	var image = new Image();
	image.src = canvas.toDataURL("image/png");
	return image;
}
$(document).ready(function(){
	$("#update-rankings-btn").click(function(){
		submitRankings();
	});	
	reorderActions();
	reorderRankings(); 
	$("#snap").click(function(){
		canvas = document.getElementById("canvas");
		context = canvas.getContext("2d");
		video = document.getElementById("video");
		context.drawImage(video, 0, 0, 320, 240);
	});
	$("#use-image-btn").click(function(){
		selected_canvas = $(".selected-row").children('.applicant-canvas-td').children('.applicant-canvas')[0];
		// canvas = document.getElementById("tiny-image-canvas"),
		canvas = selected_canvas;
		context = canvas.getContext("2d"),
		pic = document.getElementById("canvas")
		context.drawImage(pic, 0, 0, 64, 48);
	});
	boldActions();
	

})
</script>

<style type = 'text/css'>
.applicant-rank-input{
	width: 50px;
}
.selected-row{
	font-weight:bold;
}
.applicant-row:hover{
	cursor:pointer;
}
</style>
<h1>Ranking Applicants To <%= @committee.name %> For <%= @deliberation.name %></h1>

<div class = 'col-md-4'>
	<button id = 'update-rankings-btn' class = 'btn btn-default'>Update Rankings</button>
	<table class = 'table table-striped'>
		<thead>
			<tr>
				<th>Name</th>
				<th>Rank</th>
				<th>Image</th>
			</tr>
		</thead>

		<tbody id = 'ranking-table-body'>
			<% @applicants.each do |applicant| %>
			<tr class = 'applicant-row' id = '<%= applicant.id %>'>
				<td class = 'applicant-name-td'><%= applicant.name %></td>
				<td class = 'applicant-rank-td'><input type = 'text' class = 'applicant-rank-input form-control' value = '<%= applicant.committee_rank(@committee.id).value %>'/></td>
				<td class = 'applicant-canvas-td'><canvas class = 'applicant-canvas' id ='canvas-<%= applicant.id %>'  width="64" height = "48"></canvas></td>
			</tr>
			<% end %>
		</tbody>
	</table>
</div>

<div class = 'col-md-4'>
	<canvas id = 'preview-canvas'  width="320" height = "240"></canvas>
</div>

<script type = 'text/javascript'>
// Put event listeners into place
window.addEventListener("DOMContentLoaded", function() {
	// Grab elements, create settings, etc.
	var canvas = document.getElementById("canvas"),
		context = canvas.getContext("2d"),
		video = document.getElementById("video"),
		videoObj = { "video": true },
		errBack = function(error) {
			console.log("Video capture error: ", error.code); 
		};

	// Put video listeners into place
	if(navigator.getUserMedia) { // Standard
		navigator.getUserMedia(videoObj, function(stream) {
			video.src = stream;
			video.play();
		}, errBack);
	} else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
		navigator.webkitGetUserMedia(videoObj, function(stream){
			video.src = window.webkitURL.createObjectURL(stream);
			video.play();
		}, errBack);
	}
	else if(navigator.mozGetUserMedia) { // Firefox-prefixed
		navigator.mozGetUserMedia(videoObj, function(stream){
			video.src = window.URL.createObjectURL(stream);
			video.play();
		}, errBack);
	}
}, false);

// Trigger photo take
// document.getElementById("snap").addEventListener("click", function() {
// 	
// });
</script>

<div class = 'col-md-4'>

<video id="video" width="320" height = "240" autoplay></video>
<button id="snap" class = "btn btn-default">Snap Picture</button>
<button id="use-image-btn" class = "btn btn-default">Use This Image</button>
<h2>Image Preview</h2>
<canvas id="canvas" width="320" height = "240" ></canvas>

</div>

